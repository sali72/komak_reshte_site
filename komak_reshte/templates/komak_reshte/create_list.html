<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Field of Study List</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
</head>
<body>
    <h1>Create Your List of Fields of Study</h1>
    <!-- Form for adding a field of study -->
    <form method="post">
        {% csrf_token %}
        <div>
            <label for="province">Province:</label>
            {{ form.province }}
        </div>
        <div>
            <label for="field_of_study">Field of Study:</label>
            {{ form.field_of_study }}
        </div>
        <button type="submit">Add to List</button>
    </form>
    <!-- Display the current list -->
    <h2>Your List</h2>
    <ul id="sortable-list">
        {% if field_list %}
            {% for item in field_list %}
                <li data-id="{{ item.field_of_study }}">{{ item.field_of_study }} - <span class="order">Order: {{ item.order }}</span></li>
            {% endfor %}
        {% else %}
            <li>No items in the list yet.</li>
        {% endif %}
    </ul>
    <!-- Clear List Button -->
    <button id="clear-list-btn">Clear List</button>
    <!-- Export button (if you want to add an export option) -->
    <form method="post" action="{% url 'komak_reshte:export_csv' %}">
        {% csrf_token %}
        <button type="submit">Export to CSV</button>
    </form>

    <script>
        $(document).ready(function() {
            $('#id_province').change(function() {
                var province = $(this).val();
                $.ajax({
                    url: '{% url "komak_reshte:get_fields_of_study" %}',
                    data: {
                        'province': province
                    },
                    success: function(data) {
                        updateFieldsOfStudy(data.fields_of_study);
                    }
                });
            });

            function updateFieldsOfStudy(fields_of_study) {
                var $fieldOfStudy = $('#id_field_of_study');
                $fieldOfStudy.empty(); // Clear previous options
                $fieldOfStudy.append('<option value="">None</option>'); // Add the default option
                $.each(fields_of_study, function(index, field) {
                    var displayText = `${field.name} - ${field.university} (Code: ${field.unique_code})`;
                    $fieldOfStudy.append('<option value="' + field.id + '">' + displayText + '</option>');
                });
            }

            // Initialize Sortable
            new Sortable(document.getElementById('sortable-list'), {
                animation: 150,
                onEnd: function (evt) {
                    updateOrder();
                }
            });

            function updateOrder() {
                let order = 1;
                $('#sortable-list li').each(function() {
                    $(this).find('.order').text('Order: ' + order);
                    order++;
                });
            }

            // Clear List Button
            $('#clear-list-btn').click(function() {
                if (confirm('Are you sure you want to clear the list?')) {
                    $.ajax({
                        url: '{% url "komak_reshte:clear_list" %}',
                        type: 'POST',
                        data: {
                            'csrfmiddlewaretoken': '{{ csrf_token }}'
                        },
                        success: function() {
                            location.reload();
                        }
                    });
                }
            });
        });
    </script>
</body>
</html>
